#!/usr/bin/env python2 -u
import argparse
import textwrap
import sys
import sldb.common.config as config
from sldb.importing.delimited import IMPORT_HEADERS

class FieldsAction(argparse.Action):
    def __call__(self, parser, namespace, values, option_string=None):
        print '\n'.join(textwrap.wrap(
           'Required fields must be specified in the header for every '
           'sequence, or as a default.  Failure to do so will cause '
           'an error.'
        , 80)) + '\n'
        ml = max(map(lambda e: len(e), IMPORT_HEADERS.keys()))
        for k in sorted(IMPORT_HEADERS.keys()):
            print '  {}: {}'.format(k.ljust(ml), IMPORT_HEADERS[k])
        parser.exit()

if __name__ == '__main__':
    parser = config.get_base_arg_parser(
        'Imports a delimited file.  If a field is not specified by any flag '
        'it is assumed to have the same header in the imported file(s).  If '
        'specified with a --map-FIELD flag, the header field specified will '
        'be used.  If specified with a --def-FIELD, the literal value will be '
        'used.  Specifying a field with both methods is valid, and the value '
        'will first be looked up with the header specified with --map-FIELD '
        'and will fall back to the default value if not specified.  Valid '
        'fields.')
    parser.add_argument('v_germlines', help='Path to V germlines file')
    parser.add_argument('j_germlines', help='Path to J germlines file')
    parser.add_argument('files', nargs='+', help='Files to import')

    parser.add_argument('--defaults', nargs='+', help='Default values for '
                        'fields. Format as FIELD1=VALUE1 FIELD2=VALUE2')
    parser.add_argument('--mappings', nargs='+', help='Mappings for field. '
                        'Format as FIELD1=HEADER2 FIELD2=HEADER2')
    parser.add_argument('--print-fields', action=FieldsAction, nargs=0,
                        help='Displays all valid fields. Does not process '
                        'any input.')
    parser.add_argument('--delimiter', default='\t', help='Field delimiter '
                        '(Default: tab)')
    parser.add_argument('--v-addition', type=int, default=0, help='The number '
        'of nucleotides in the CDR3 included in the `v_length` field.  For '
        'example if the first amino-acid (usually C) of the CDR3 is included '
        'in the V length, this should be set to 3. (Default: 0)')
    parser.add_argument('--v-len-has-gaps', default=False, action='store_true',
            help='If set the V length is treated assumed to include gaps.')
    parser.add_argument('--j-offset', default=31, type=int, help='Number of J '
        'gene nucleotides upstream from the CDR3. (Default: 31)')
    parser.add_argument('--fail-action', default='warn', help='Action to take '
        'when parsing a sequence fails (e.g. unknown V-gene).  Valid values '
        'are \'pass\' to silently pass, \'warn\' to warn but continue, and '
        '\'fail\' to stop processing.  \'fail\' may result in database '
        'inconsistencies. (Default: warn)')
    args = parser.parse_args()
    if args.fail_action not in ('pass', 'warn', 'fail'):
        parser.error('--fail-action must be pass, warn, or fail')

    session = config.init_db(args.master_db_config, args.data_db_config)

    from sldb.importing.delimited import run_delimited_import
    sys.exit(run_delimited_import(session, args))
