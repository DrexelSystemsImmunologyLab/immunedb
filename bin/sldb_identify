#!/usr/bin/env python2
import sys
import argparse
import sldb.common.config as config

if __name__ == '__main__':
    parser = config.get_base_arg_parser('Identifies V and J genes from '
                                        'FASTA files', multiproc=True)
    parser.add_argument('base_dirs', nargs='+', help='Base directories for '
                        'samples.')
    parser.add_argument('v_germlines', help='FASTA file with IMGT gapped '
                        'V-gene germlines')
    parser.add_argument('--limit-alignments', nargs='+',
                        default=('R1', 'R1+R2'), help='Read types to process '
                        '(R1, R2, and/or R1+R2).  Default: R1 R1+R2')
    parser.add_argument('--max-vties', type=int, default=50, help='Maximum '
                        'number of V-ties to allow in a valid sequence. '
                        'V-ties resulting in a name longer than 512 characters'
                        ' will be truncated. (Default: 50)')
    parser.add_argument('--min-similarity', type=int, default=60,
                        help='Minimum percent similarity to germline required '
                        'for valid sequences. (Default: 60)')
    parser.add_argument('--read-format', default='fastq',
                        help='Input format.  May be \'fasta\' or \'fastq\' '
                        '(Default: fastq)')
    parser.add_argument('--incl-all', action='store_true', help='If set will '
                        'attempt to process all files in the directories '
                        'using the `all` metadata key for those files which '
                        'do not have an explicit entry.')

    args = parser.parse_args()
    if args.read_format not in ('fasta', 'fastq'):
        parser.error('Invalid read format {}'.format(args.read_format))

    session = config.init_db(args.master_db_config, args.data_db_config)

    from sldb.identification.identify import run_identify
    sys.exit(run_identify(session, args))
